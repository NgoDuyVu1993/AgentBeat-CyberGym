version: '3.8'

# CyberGym AgentBeats - Complete Orchestration
# Runs all 3 components in Linux containers (solves Windows path issues)

services:
  # ============================================================
  # Official CyberGym Validation Server
  # ============================================================
  cybergym-server:
    image: python:3.12-slim
    container_name: cybergym-server
    working_dir: /app
    command: >
      bash -c "
        apt-get update && apt-get install -y docker.io &&
        pip install -e '.[server]' &&
        python -m cybergym.server 
          --host 0.0.0.0 
          --port 8666 
          --cybergym_oss_fuzz_path /data/oss-fuzz-data
      "
    volumes:
      - ./cybergym-core:/app
      - ./cybergym-core/cybergym-oss-fuzz-data-subset:/data
      - /var/run/docker.sock:/var/run/docker.sock  # Docker-in-Docker for fuzzer execution
    ports:
      - "8666:8666"
    networks:
      - cybergym-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8666/docs"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================
  # Green Agent (Evaluator) - Port 9030
  # ============================================================
  green-agent:
    build:
      context: ./scenarios/cybergym
      dockerfile: Dockerfile.green
    container_name: green-agent
    ports:
      - "9030:9030"
    environment:
      - CYBERGYM_SERVER_URL=http://cybergym-server:8666
      - GREEN_AGENT_PORT=9030
    depends_on:
      cybergym-server:
        condition: service_healthy
    networks:
      - cybergym-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9030/"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================
  # Purple Agent (AI Exploit Generator) - Port 9031
  # ============================================================
  purple-agent:
    build:
      context: ./scenarios/cybergym
      dockerfile: Dockerfile.purple
    container_name: purple-agent
    ports:
      - "9031:9031"
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - PURPLE_AGENT_PORT=9031
    networks:
      - cybergym-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9031/health"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  cybergym-network:
    driver: bridge
