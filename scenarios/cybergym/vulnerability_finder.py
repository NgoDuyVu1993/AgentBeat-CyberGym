"""
scenario/cybergym/vulnerability_finder.py
CyberGym Green Agent - Evaluates Purple Agents on vulnerability finding tasks
Part of the AgentBeats + CyberGym integration for Berkeley RDI Competition
"""

import json
import os
import json
from fastapi import FastAPI
import uvicorn
import requests

# Create a web application
app = FastAPI(title="Vulnerability Finder - Purple Agent")

@app.get("/")
def home():
    """This tells other agents what this agent is"""
    return {
        "name": "Vulnerability Finder",
        "type": "purple_agent",
        "version": "3.0.0",
        "status": "ready"
    }

@app.post("/task")
async def handle_task(task: dict):
    """Process vulnerability task and submit to server"""
    print("\n" + "="*50)
    print("RECEIVED TASK")
    print("="*50)
    
    # Extract task information
    task_id = task.get("task_id", "unknown")
    config = task.get("config", {})
    description = config.get("description", "")
    vuln_type = config.get("vulnerability_type", "unknown")
    submission_endpoint = config.get("submission_endpoint")
    agent_id = config.get("agent_id", "vulnerability_finder_v1")
    
    print(f"Task ID: {task_id}")
    print(f"Type: {vuln_type}")
    print(f"Description: {description[:200]}...")
    
    # Generate PoC based on vulnerability type
    poc = generate_poc(vuln_type, description, task_id)
    
    print(f"\nGenerated PoC: {poc[:50]}..." if len(poc) > 50 else f"Generated PoC: {poc}")
    
    # Submit to mock server if endpoint provided
    submitted = False
    submission_result = None
    
    if submission_endpoint:
        print(f"Submitting PoC to {submission_endpoint}...")
        try:
            # Prepare submission
            files = {'file': ('poc', poc.encode('utf-8'), 'application/octet-stream')}
            data = {
                'metadata': json.dumps({
                    'task_id': task_id,
                    'agent_id': agent_id
                })
            }
            
            # Submit
            submit_response = requests.post(
                submission_endpoint,
                files=files,
                data=data,
                timeout=5
            )
            
            if submit_response.status_code == 200:
                submission_result = submit_response.json()
                submitted = True
                print(f"✓ Submitted successfully")
                print(f"  Exit code: {submission_result.get('exit_code')}")
            else:
                print(f"✗ Submission failed with status {submit_response.status_code}")
                
        except Exception as e:
            print(f"✗ Error submitting: {e}")
    
    # Create response
    response = {
        "status": "completed",
        "task_id": task_id,
        "poc": poc,
        "poc_size": len(poc),
        "vulnerability_found": True,
        "confidence": 0.8,
        "submitted_to_server": submitted,
        "submission_result": submission_result,
        "message": f"Found {vuln_type} vulnerability and generated PoC"
    }
    
    print("\n" + "="*50)
    print("TASK COMPLETED")
    print("="*50)
    
    return response

def generate_poc(vuln_type: str, description: str, task_id: str):
    """
    Generate PoC based on vulnerability type and task
    Enhanced version with task-specific patterns
    """
    
    # Task-specific PoCs (for known tasks)
    task_specific_pocs = {
        "arvo:10400": "A" * 500,  # Buffer overflow
        "arvo:47101": "AAA" + "B" * 200,  # Specific pattern
        "arvo:3938": "BBB" + "\x00" * 10,  # With null bytes
        "arvo:24993": "overflow" + "A" * 100,
        "arvo:1065": "\x00\x01" + "A" * 50,
        "arvo:368": "%x%x%x%s%n",  # Generic format string attempt
        "oss-fuzz:42535201": "FUZZ" * 100,  # Generic fuzzing attempt
    }
    
    # Check if we have a specific PoC for this task
    if task_id in task_specific_pocs:
        return task_specific_pocs[task_id]
    
    # Otherwise use pattern-based generation
    poc_patterns = {
        "buffer_overflow": "A" * 200,
        "format_string": "%s%s%s%s%n",
        "sql_injection": "' OR '1'='1",
        "xss": "<script>alert('XSS')</script>",
        "command_injection": "; ls -la",
        "segmentation_fault": "\x00" * 100,
        "unknown": "AAAA"
    }
    
    poc = poc_patterns.get(vuln_type, poc_patterns["unknown"])
    
    # Add variations based on description
    if "buffer" in description.lower() or "overflow" in description.lower():
        poc = "A" * 500
    elif "format" in description.lower():
        poc = "%x%x%x%s%n"
    elif "heap" in description.lower():
        poc = "H" * 300
    elif "stack" in description.lower():
        poc = "S" * 250
    
    return poc    


if __name__ == "__main__":
    print("Starting Vulnerability Finder on http://127.0.0.1:9031")
    # This starts the web server
    uvicorn.run(app, host="127.0.0.1", port=9031)